---
- name: Create custom Kibana developer role in Elasticsearch
  uri:
    url: "{{ elasticsearch_protocol }}://{{ elasticsearch_host }}:{{ elasticsearch_port }}/_security/role/{{ kibana_user_role_name }}"
    method: POST
    user: "{{ elasticsearch_admin_user }}"
    password: "{{ elasticsearch_admin_password }}"
    force_basic_auth: yes
    body_format: json
    validate_certs: "{{ validate_certs }}"
    status_code: [200]
    body:
      cluster:
        - "monitor"
        - "manage_index_templates"
        - "monitor_snapshot"
        - "manage_ilm"
        - "manage"
        - "manage_own_api_key"
      indices:
        - names: ["*"]
          privileges:
            - "create_index"
            - "create"
            - "delete"
            - "index"
            - "manage"
            - "read"
            - "write"
            - "view_index_metadata"
            - "monitor"
      applications:
        - application: "kibana-.kibana"
          privileges:
            - "feature_discover.all"
            - "feature_visualize.all"
            - "feature_dashboard.all"
            - "feature_dev_tools.all"
            - "feature_advancedSettings.read"
            - "feature_indexPatterns.all"
            - "feature_savedObjectsManagement.all"
            - "feature_indexLifecycleManagement.all"
          resources: ["*"]
  register: role_creation
  changed_when: role_creation.status == 201

- name: Display role creation result
  debug:
    msg: "Role {{ kibana_user_role_name }} created/updated successfully"
  when: role_creation.status in [200, 201]

- name: Create Kibana users in Elasticsearch
  uri:
    url: "{{ elasticsearch_protocol }}://{{ elasticsearch_host }}:{{ elasticsearch_port }}/_security/user/{{ kibana_user_prefix }}{{ item }}"
    method: POST
    user: "{{ elasticsearch_admin_user }}"
    password: "{{ elasticsearch_admin_password }}"
    force_basic_auth: yes
    body_format: json
    validate_certs: "{{ validate_certs }}"
    status_code: [200]
    body:
      password: "{{ kibana_user_default_password }}"
      roles:
        - "{{ kibana_user_role_name }}"
      full_name: "Kibana Developer User {{ item }}"
      email: "{{ kibana_user_prefix }}{{ item }}@example.com"
      enabled: true
  loop: "{{ range(1, kibana_users_count + 1) | list }}"
  register: user_creation
  changed_when: user_creation.status == 201

- name: Display created users
  debug:
    msg: "{{ 'Created' if item.status == 200}}: {{ kibana_user_prefix }}{{ item.item }}"
  loop: "{{ user_creation.results }}"
  when: user_creation.results is defined

- name: Summary of created users
  debug:
    msg:
      - "=========================================="
      - "Kibana Users Creation Summary"
      - "=========================================="
      - "Total users processed: {{ kibana_users_count }}"
      - "Username pattern: {{ kibana_user_prefix }}[1-{{ kibana_users_count }}]"
      - "Default password: {{ kibana_user_default_password }}"
      - "Role assigned: {{ kibana_user_role_name }}"
      - "=========================================="
      - "Users have the following permissions:"
      - "  - Adjust cluster settings"
      - "  - Create and manage indices"
      - "  - Access Kibana Dev Tools"
      - "  - View Elasticsearch cluster health and metrics"
      - "  - Full access to Discover, Visualize, and Dashboard"
      - "  - Create and manage ILM policies"
      - "  - Full access to Index Lifecycle Management UI"
      - "  - Create and manage their own API keys"
      - "=========================================="
      - "IMPORTANT: Users should change their password on first login!"
      - "=========================================="
